# rabbitmq-ha-statefulset.yaml
# Implementa los Objetivos 1 y 2: HA (StatefulSet) y Persistencia (PVC Templates).

# A. Servicio Headless (Descubrimiento y Clustering)
apiVersion: v1
kind: Service
metadata:
  name: rabbitmq-ha-headless
  namespace: mensajeria
  labels:
    app: rabbitmq
spec:
  # clusterIP: None es clave para un servicio headless
  clusterIP: None
  ports:
    - name: amqp
      port: 5672
    - name: epmd
      port: 4369 # Puerto de distribución Erlang para clustering
    - name: management
      port: 15672
    - name: metrics
      port: 15692
  selector:
    app: rabbitmq
---

# B. StatefulSet (HA con 3 Réplicas)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rabbitmq-ha
  namespace: mensajeria
  labels:
    app: rabbitmq
spec:
  # Objetivo 1: 3 Réplicas HA
  replicas: 3
  selector:
    matchLabels:
      app: rabbitmq
  serviceName: "rabbitmq-ha-headless" 
  template:
    metadata:
      labels:
        app: rabbitmq
    spec:
      containers:
        - name: rabbitmq
          # Imagen estable que incluye Management y Prometheus Exporter
          image: rabbitmq:3-management-alpine 
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 5672
            - containerPort: 15672
            - containerPort: 15692
          env:
            # 1. Cookie Secreta (Debe ser idéntica en todos los nodos)
            - name: RABBITMQ_ERLANG_COOKIE
              value: "CLUSTERING_SECRETO_RABBIT" 
            # 2. Credenciales (usadas por ms-notificaciones y apps)
            - name: RABBITMQ_DEFAULT_USER
              value: user
            - name: RABBITMQ_DEFAULT_PASS
              value: password123
          volumeMounts:
            # Monta la configuración de plugins y clustering
            - name: config-volume
              mountPath: /etc/rabbitmq/rabbitmq.conf
              subPath: rabbitmq.conf
            - name: config-volume
              mountPath: /etc/rabbitmq/enabled_plugins
              subPath: enabled_plugins
            # Monta la persistencia (Objective 2)
            - name: rabbitmq-storage
              mountPath: /var/lib/rabbitmq/mnesia/
      volumes:
        - name: config-volume
          configMap:
            name: rabbitmq-config # Referencia al ConfigMap anterior

  # C. VolumeClaimTemplates (Objetivo 2: Persistencia)
  volumeClaimTemplates:
  - metadata:
      name: rabbitmq-storage
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: "standard" # AJUSTAR SI TU CLÚSTER USA OTRO NOMBRE
      resources:
        requests:
          storage: 8Gi # 8GB de almacenamiento persistente por nodo (3 PVCs en total)